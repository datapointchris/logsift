# Pre-commit hook output patterns
# Patterns to capture error and warning output from pre-commit hooks
# Organized by tool category for maintainability
#
# This file contains patterns for detecting issues in pre-commit hook output,
# enabling logsift to filter verbose pre-commit runs for actionable errors.
#
# Pattern testing methodology:
# 1. Created violation files that trigger specific hook failures
# 2. Ran hooks in isolation to capture output format
# 3. Verified patterns match real hook output
# 4. Each pattern has corresponding test in test_precommit_patterns.py

# ============================================================================
# Shell Script Linting - shellcheck
# ============================================================================

[[patterns]]
name = "shellcheck_file_location"
regex = "^In (.+?) line (\\d+):"
severity = "error"
description = "Shellcheck issue location header"
tags = ["pre-commit", "shellcheck", "shell", "location"]

[[patterns]]
name = "shellcheck_error"
regex = "SC(\\d+) \\(error\\): (.+)"
severity = "error"
description = "Shellcheck error with SC code"
tags = ["pre-commit", "shellcheck", "shell", "error"]
suggestion = "Fix shell script issue according to shellcheck guidance"

[[patterns]]
name = "shellcheck_warning"
regex = "SC(\\d+) \\(warning\\): (.+)"
severity = "warning"
description = "Shellcheck warning with SC code"
tags = ["pre-commit", "shellcheck", "shell", "warning"]
suggestion = "Address shell script warning according to shellcheck guidance"

[[patterns]]
name = "shellcheck_info"
regex = "SC(\\d+) \\(info\\): (.+)"
severity = "warning"
description = "Shellcheck info/style suggestion"
tags = ["pre-commit", "shellcheck", "shell", "info", "style"]

[[patterns]]
name = "shellcheck_note"
regex = "SC(\\d+) \\(note\\): (.+)"
severity = "warning"
description = "Shellcheck informational note"
tags = ["pre-commit", "shellcheck", "shell", "note"]

# ============================================================================
# Python Refactoring Suggestions - refurb
# ============================================================================

[[patterns]]
name = "refurb_suggestion"
regex = "^(.+?):(\\d+):(\\d+) \\[FURB(\\d+)\\]: (.+)"
severity = "warning"
description = "Refurb refactoring suggestion"
tags = ["pre-commit", "refurb", "python", "refactoring", "style"]
suggestion = "Apply refurb suggestion to modernize Python code"

# ============================================================================
# Python Type Checking - mypy
# ============================================================================

[[patterns]]
name = "mypy_error"
regex = "^(.+?):(\\d+): error: (.+?)  \\[(.+?)\\]"
severity = "error"
description = "Mypy type checking error"
tags = ["pre-commit", "mypy", "python", "type-checking", "error"]
suggestion = "Fix type annotation or type incompatibility"

[[patterns]]
name = "mypy_error_no_code"
regex = "^(.+?):(\\d+): error: (.+)$"
severity = "error"
description = "Mypy type checking error (no error code)"
tags = ["pre-commit", "mypy", "python", "type-checking", "error"]

[[patterns]]
name = "mypy_note"
regex = "^(.+?):(\\d+): note: (.+)"
severity = "warning"
description = "Mypy informational note"
tags = ["pre-commit", "mypy", "python", "type-checking", "note"]

[[patterns]]
name = "mypy_warning"
regex = "^(.+?):(\\d+): warning: (.+)"
severity = "warning"
description = "Mypy warning"
tags = ["pre-commit", "mypy", "python", "type-checking", "warning"]

# ============================================================================
# Python Linting - ruff
# ============================================================================

[[patterns]]
name = "ruff_error"
regex = "^(.+?):(\\d+):(\\d+): ([A-Z]\\d+) (.+)"
severity = "error"
description = "Ruff linting error"
tags = ["pre-commit", "ruff", "python", "linting", "error"]
suggestion = "Fix code style or logic issue according to ruff guidance"

[[patterns]]
name = "ruff_error_simple"
regex = "^(.+?):(\\d+):(\\d+): ([A-Z]\\d+)"
severity = "error"
description = "Ruff linting error (code only)"
tags = ["pre-commit", "ruff", "python", "linting", "error"]

# ============================================================================
# Spell Checking - codespell
# ============================================================================

[[patterns]]
name = "codespell_typo"
regex = "^(.+?):(\\d+): (.+?) ==> (.+)"
severity = "warning"
description = "Codespell spelling error"
tags = ["pre-commit", "codespell", "spelling", "typo"]
suggestion = "Fix spelling mistake"

# ============================================================================
# File Format Validation - check-yaml, check-toml, check-json
# ============================================================================

[[patterns]]
name = "check_yaml_error"
regex = "^  in \"(.+?)\", line (\\d+), column (\\d+)"
severity = "error"
description = "YAML syntax error location"
tags = ["pre-commit", "yaml", "syntax", "validation"]

[[patterns]]
name = "check_toml_error"
regex = "^(.+?): (.+?) \\(at line (\\d+), column (\\d+)\\)"
severity = "error"
description = "TOML syntax error"
tags = ["pre-commit", "toml", "syntax", "validation"]

[[patterns]]
name = "check_json_error"
regex = "^(.+?): Failed to json decode \\((.+?)\\)"
severity = "error"
description = "JSON syntax error"
tags = ["pre-commit", "json", "syntax", "validation"]

# ============================================================================
# File Safety Checks
# ============================================================================

[[patterns]]
name = "check_executable_no_shebang"
regex = "^(.+?): marked executable but has no \\(or invalid\\) shebang!"
severity = "warning"
description = "Executable file missing shebang"
tags = ["pre-commit", "shebang", "executable", "shell"]
suggestion = "Add shebang line or remove executable permission"

[[patterns]]
name = "detect_private_key"
regex = "^Private key found: (.+)"
severity = "error"
description = "Private key detected in repository"
tags = ["pre-commit", "security", "private-key", "secrets"]
suggestion = "Remove private key from repository immediately"

# ============================================================================
# Python Security Scanning - bandit
# ============================================================================

[[patterns]]
name = "bandit_issue_header"
regex = "^>> Issue: \\[([A-Z]\\d+):[^\\]]+\\] (.+)"
severity = "warning"
description = "Bandit security issue header"
tags = ["pre-commit", "bandit", "security", "python"]

[[patterns]]
name = "bandit_severity_high"
regex = "^   Severity: High"
severity = "error"
description = "Bandit high severity security issue"
tags = ["pre-commit", "bandit", "security", "python", "high-severity"]
suggestion = "Address high severity security issue immediately"

[[patterns]]
name = "bandit_severity_medium"
regex = "^   Severity: Medium"
severity = "warning"
description = "Bandit medium severity security issue"
tags = ["pre-commit", "bandit", "security", "python", "medium-severity"]

[[patterns]]
name = "bandit_location"
regex = "^   Location: (.+?):(\\d+):(\\d+)"
severity = "warning"
description = "Bandit issue location"
tags = ["pre-commit", "bandit", "security", "location"]

# ============================================================================
# Markdown Linting - markdownlint
# ============================================================================

[[patterns]]
name = "markdownlint_error"
regex = "^(.+?):(\\d+) (MD\\d+)/([^\\s]+) (.+?)(?:\\s+\\[Context: \"(.+?)\"\\])?$"
severity = "error"
description = "Markdownlint rule violation"
tags = ["pre-commit", "markdownlint", "markdown", "style"]
suggestion = "Fix markdown style issue according to markdownlint rule"

# ============================================================================
# Multi-line Error Patterns - CalledProcessError and subprocess failures
# ============================================================================
# These patterns capture errors that span multiple lines, where the actual
# root cause appears in subsequent lines (stdout/stderr sections).
# context_lines_after tells logsift to extract additional lines for context.

[[patterns]]
name = "pre_commit_called_process_error"
regex = "An unexpected error has occurred: CalledProcessError"
severity = "error"
description = "Pre-commit hook encountered subprocess error"
tags = ["pre-commit", "subprocess", "multi-line"]
suggestion = "Check stderr and stdout in following lines for root cause"
context_lines_after = 10

[[patterns]]
name = "stderr_section_error"
regex = "^stderr:\\s*$"
severity = "error"
description = "Marks beginning of stderr output section"
tags = ["stderr", "multi-line", "section-marker"]
suggestion = "Extract following lines - they contain actual error message"
context_lines_after = 5

[[patterns]]
name = "pre_commit_hook_failed"
regex = "^- hook id: (.+)$"
severity = "warning"
description = "Pre-commit hook identifier"
tags = ["pre-commit", "hook-id"]

[[patterns]]
name = "pre_commit_exit_code"
regex = "^- exit code: (\\d+)$"
severity = "error"
description = "Pre-commit hook exit code"
tags = ["pre-commit", "exit-code"]

# ============================================================================
# Docker and Infrastructure Errors
# ============================================================================
# Patterns for docker-related failures that often appear in pre-commit hooks

[[patterns]]
name = "docker_socket_connection_failure"
regex = "failed to connect to the docker API at unix://([^;\\s]+)"
severity = "error"
description = "Docker daemon not reachable via socket"
tags = ["docker", "infrastructure", "socket"]
suggestion = "Start Docker daemon: check if Docker Desktop or Colima is running"

[[patterns]]
name = "docker_daemon_not_running"
regex = "Cannot connect to the Docker daemon"
severity = "error"
description = "Docker daemon is not running"
tags = ["docker", "infrastructure", "daemon"]
suggestion = "Start Docker: 'open -a Docker' or 'colima start'"

[[patterns]]
name = "pre_commit_check_log"
regex = "Check the log at (.+\\.log)"
severity = "warning"
description = "Pre-commit suggests checking detailed log"
tags = ["pre-commit", "log-reference"]
suggestion = "Additional diagnostic info available in referenced log file"
